# RPM List Builder config that downloads from https://github.com/sclorg-distgit
#
# Temporary spec overrides:
#
#     sclo-python: still under ncoghlan's personal repos rather than sclorg-distgit
#     python: currently using ncoghlan's python-spec fork of that repo

before_download:
  - echo "Retrieving RPM specs from sclorg-distgit"
  - pwd
download:
  - |
    echo "Downloading PKG: ${PKG}"
    if [ "${PKG}" = "rh-python35" ] || [ "${PKG}" = "python" ]; then
        echo Using package definition from personal repo
        export BASE_REPO_URL="https://github.com/ncoghlan"
        export REPO_BRANCH="sig-sclo7-sclo-python"
        if [ "${PKG}" = "rh-python35" ]; then
            export REPO_NAME="sclo-python"
        fi
        if [ "${PKG}" = "python" ]; then
            export REPO_NAME="python-spec"
        fi
    else
        echo Using package definition from sclorg-distgit
        export BASE_REPO_URL="https://github.com/sclorg-distgit"
        export REPO_BRANCH="sig-sclo7-rh-python35-rh"
        export REPO_NAME=${PKG}
    fi
    if [ "${REPO_NAME}" != "" ]; then
        if [ ! -d ${REPO_NAME} ]; then
            export REPO_URL="${BASE_REPO_URL}/${REPO_NAME}.git"
            echo Cloning ${REPO_URL}
            git clone ${REPO_URL}
        fi
        if [ "${REPO_NAME}" != "${PKG}" ]; then
            ln -sf ${REPO_NAME} ${PKG}
        fi
        pushd ${PKG}
        git pull
        git checkout ${REPO_BRANCH}
        popd
    fi
  - pwd
before_build:
  - echo "Building for x86-64 EL7 with mock & scl-utils"
  - pwd
  # Skip cleaning the chroot for now to speed up local iterations
  - echo "Skipping 'mock -r ${CUSTOM_DIR}/sig-sclo7-x86_64.cfg --scrub=all'"
  - mock -r ${CUSTOM_DIR}/sig-sclo7-x86_64.cfg --no-clean --install yum
build:
  - |
    set -e
    if [ "${PKG}" = "sclo-python" ]; then
        # Currently still building the rh-python35 SCL, not sclo-python
        export PKG=rh-python35
    fi
    echo "Building PKG: ${PKG}"
    rm -v *.rpm || true

    fedpkg --release el7 --module-name ${PKG} srpm
    mkdir -p built_rpms
    rm -v built_rpms/*.rpm || true
    mock -r ${CUSTOM_DIR}/sig-sclo7-x86_64.cfg --resultdir built_rpms --no-clean --no-cleanup-after --rpmbuild-opts '--define "scl rh-python35"' *.rpm
    pushd built_rpms
    rm -v *.src.rpm || true
    export LAST_INSTALLED_RPM=
    for BUILT_RPM in `ls *.rpm`
    do
        export BUILT_RPM_PATH="`pwd`/${BUILT_RPM}"
        mock -r ${CUSTOM_DIR}/sig-sclo7-x86_64.cfg --no-clean --shell "mkdir -p `pwd`"
        mock -r ${CUSTOM_DIR}/sig-sclo7-x86_64.cfg --no-clean --copyin ${BUILT_RPM_PATH} ${BUILT_RPM_PATH}
        if ! mock -r ${CUSTOM_DIR}/sig-sclo7-x86_64.cfg --no-clean --shell "rpm -qp ${BUILT_RPM_PATH}"; then
            echo "Installing RPM: ${BUILT_RPM_PATH}"
            mock -r ${CUSTOM_DIR}/sig-sclo7-x86_64.cfg --no-clean --install ${BUILT_RPM_PATH}
        else
            echo "Reinstalling RPM: ${BUILT_RPM_PATH}"
            mock -r ${CUSTOM_DIR}/sig-sclo7-x86_64.cfg --no-clean --shell "yum reinstall ${BUILT_RPM_PATH}"
        fi
        export LAST_INSTALLED_RPM=${BUILT_RPM}
    done
    popd
    if [ "${LAST_INSTALLED_RPM}" = "" ]; then
        echo "No RPMs installed for ${PKG}, aborting"
        false
    fi
